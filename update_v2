#!/usr/bin/env bash
set -euo pipefail

# ---------------------------
# Root check
# ---------------------------
[ "$(id -u)" -eq 0 ] || { echo "This script must be run as root or via sudo."; exit 1; }

# ---------------------------
# Lockfile
# ---------------------------
LOCKFILE="${LOCKFILE:-/tmp/ab.lck}"
exec 200>"$LOCKFILE"
flock -n 200 || { echo "Another instance is running ($LOCKFILE)"; exit 1; }
trap 'rm -f "$LOCKFILE"' EXIT

# ---------------------------
# Config
# ---------------------------
PARU_CMD="${PARU_CMD:-paru}"
LOGFILE="${LOGFILE:-/var/log/ab_update.log}"
NEXT_SUBVOL="/NEXT"

# ---------------------------
# Detect root device and root subvolume
# ---------------------------
ROOT_DEV=$(grep ' / ' /proc/mounts | awk '{print $1}')
ROOT_ID=$(btrfs subvolume get-default / | awk '{print $2}')
ROOT_PATH=$(btrfs subvolume list / | awk -v rid="$ROOT_ID" '$2==rid {print $NF}')

# ---------------------------
# Setup stage: create /NEXT if missing
# ---------------------------
btrfs subvolume show "$NEXT_SUBVOL" >/dev/null 2>&1 || btrfs subvolume snapshot -r "/$ROOT_PATH" "$NEXT_SUBVOL"

# ---------------------------
# Snapper before snapshot
# ---------------------------
snapper -c root create --description "taken before $0 $* - $(date '+%Y-%m-%d %H:%M:%S')" || echo "Before snapshot failed" >>"$LOGFILE"

# ---------------------------
# Make /NEXT writable
# ---------------------------
btrfs property set -ts "$NEXT_SUBVOL" ro false

# ---------------------------
# Run paru inside /NEXT using systemd-nspawn
# ---------------------------
systemd-nspawn -D "$NEXT_SUBVOL" --as-pid2 sudo -u "$(logname)" /bin/bash -c "$PARU_CMD $*"

# ---------------------------
# Snapper after snapshot
# ---------------------------
snapper -c root create --description "taken after $0 $* - $(date '+%Y-%m-%d %H:%M:%S')" || echo "After snapshot failed" >>"$LOGFILE"

# ---------------------------
# Switch default subvolume to /NEXT
# ---------------------------
NEXT_ID=$(btrfs subvolume list / | awk -v tvol="$NEXT_SUBVOL" '$NF==tvol {print $2}')
btrfs subvolume set-default "$NEXT_ID" /

# ---------------------------
# Set RO/RW flags
# ---------------------------
btrfs property set -ts "/$ROOT_PATH" ro true
btrfs property set -ts "$NEXT_SUBVOL" ro false

# ---------------------------
# Log completion
# ---------------------------
echo "$(date) - Switched default to $NEXT_SUBVOL" >>"$LOGFILE"
echo "Update complete. Please reboot manually to activate /NEXT."
