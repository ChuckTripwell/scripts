#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

[ "$EUID" -ne 0 ] && echo "Run as root" && exit 1

LOCK="/var/run/ro_paru.lock"
exec 200>"$LOCK"
flock -n 200 || { echo "Another instance is running."; exit 1; }

# Cleanup on exit or interruption
cleanup() {
    # Restore root to read-only
    btrfs property set / ro true || true

    # Remove script lock
    rm -f "$LOCK"

    # Remove stale pacman lock
    if [ -f /var/lib/pacman/db.lck ]; then
        pid=$(cat /var/lib/pacman/db.lck 2>/dev/null || true)
        kill -0 "$pid" 2>/dev/null || {
            echo "Removing stale pacman lock..."
            rm -f /var/lib/pacman/db.lck
        }
    fi
}
trap cleanup EXIT INT TERM

# Subvolume helper
create_subvolume() {
    btrfs subvolume show "$1" &>/dev/null || \
    (echo "Creating subvolume $1..."; \
     mv "$1" "$1.old"; \
     btrfs subvolume create "$1"; \
     rsync -a --remove-source-files "$1.old/" "$1/"; \
     find "$1.old" -type d -empty -delete; \
     rm -rf "$1.old")
}

# Persistent writable directories
create_subvolume "/etc/NetworkManager/system-connections"
create_subvolume "/var/lib/bluetooth"

# Pre-snapshot
snapper create -d "$(echo taken before $0 $@ - at $(date +%Y%m%d_%H%M%S))"

# Temporarily make root writable for just the next command
btrfs property set / ro false
sudo -u "$(logname)" paru "$@"
btrfs property set / ro true

# Post-snapshot
snapper create -d "$(echo taken after $0 $@ - at $(date +%Y%m%d_%H%M%S))"
